<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–°å¹´åº†ç¥</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+QingKe+HuangYou&display=swap">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent; /* ç§»é™¤ç‚¹å‡»é«˜äº® */
        }

        body {
            font-family: 'ZCOOL QingKe HuangYou', monospace;
            background: #000; /* è®¾ç½®é»‘è‰²èƒŒæ™¯ä½œä¸ºå¤‡ç”¨ */
            overflow: hidden;
            height: 100vh;
            position: relative;
            cursor: pointer;
            touch-action: manipulation; /* ä¼˜åŒ–è§¦æ‘¸å“åº” */
        }

        /* è‡ªå®šä¹‰å›¾ç‰‡èƒŒæ™¯ - ç¡®ä¿å§‹ç»ˆæ˜¾ç¤ºä¸”ä¸è¢«æš—åŒ– */
        .custom-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('./images/absl.jpg'); /* æ‚¨è‡ªå·±æä¾›çš„å›¾ç‰‡è·¯å¾„ */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            z-index: 0; /* è®¾ç½®ä¸º0ç¡®ä¿åœ¨æœ€åº•å±‚ */
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šç®€åŒ–ç”»å¸ƒå±‚çº§ */
        #lanterns,
        #fireworks {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #lanterns { z-index: 2; }
        #fireworks { z-index: 1; }

        /* æ˜Ÿç©ºèƒŒæ™¯ - ç§»åŠ¨ç«¯å‡å°‘æ˜Ÿæ˜Ÿæ•°é‡ */
        #sky {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3;
        }

        /* æ–‡å­—å®¹å™¨ - ç§»åŠ¨ç«¯ä¼˜åŒ– */
        .text-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* è‰ºæœ¯æ–‡å­—æ ·å¼ - ç§»åŠ¨ç«¯å“åº”å¼å­—ä½“ */
        .art-text {
            position: absolute;
            font-family: 'Ma Shan Zheng', cursive;
            font-weight: bold;
            text-align: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.7s ease;
            white-space: nowrap;
            font-size: clamp(4rem, 20vw, 12rem); /* ä½¿ç”¨clampå®ç°å“åº”å¼å­—ä½“ */
            text-shadow:
                0 0 20px rgba(255, 215, 0, 0.8),
                0 0 40px rgba(255, 215, 0, 0.6),
                0 0 60px rgba(255, 215, 0, 0.4);
            padding: 0 20px; /* æ·»åŠ å†…è¾¹è·é˜²æ­¢æº¢å‡º */
        }

        /* ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šç®€åŒ–æ¸å˜æ•ˆæœ */
        .art-text-0 { color: #FFD700; }
        .art-text-1 { color: #4CAF50; }
        .art-text-2 { color: #FF6B6B; }
        .art-text-3 { color: #4A90E2; }
        .art-text-4 { color: #FF4081; }

        /* ç§»é™¤æ¸å˜èƒŒæ™¯ï¼ˆç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–ï¼‰ */
        .art-text-0,
        .art-text-1,
        .art-text-2,
        .art-text-3,
        .art-text-4 {
            -webkit-background-clip: initial;
            -webkit-text-fill-color: initial;
            background-clip: initial;
            background: none;
        }

        /* æ–°å¹´å¿«ä¹é“¾æ¥ - ç§»åŠ¨ç«¯ä¼˜åŒ– */
        .new-year-link {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0;
            color: transparent;
            text-decoration: none;
            pointer-events: none;
            z-index: 20;
            width: min(800px, 90vw); /* é™åˆ¶æœ€å¤§å®½åº¦ */
            height: min(200px, 40vh); /* é™åˆ¶æœ€å¤§é«˜åº¦ */
        }

        .new-year-link.active {
            pointer-events: auto;
        }

        /* æ§åˆ¶é¢æ¿ - ç§»åŠ¨ç«¯åº•éƒ¨å±…ä¸­ */
        .controls {
            position: fixed;
            bottom: max(20px, env(safe-area-inset-bottom)); /* å®‰å…¨åŒºåŸŸé€‚é… */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            flex-direction: row; /* æ”¹ä¸ºæ°´å¹³æ’åˆ— */
            gap: 10px;
            z-index: 1000;
            padding: 0 20px;
            width: 100%;
            justify-content: center;
        }

        .control-btn {
            padding: 12px 16px; /* å¢å¤§è§¦æ‘¸åŒºåŸŸ */
            background: rgba(0, 0, 0, 0.85);
            color: white;
            border: 2px solid rgba(76, 175, 80, 0.5);
            border-radius: 12px;
            cursor: pointer;
            font-family: 'Ma Shan Zheng', cursive;
            font-size: 0.95rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 100px;
            justify-content: center;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
            backdrop-filter: blur(5px); /* æ·»åŠ èƒŒæ™¯æ¨¡ç³Šæ•ˆæœ */
        }

        .control-btn:hover {
            background: rgba(76, 175, 80, 0.2);
            transform: scale(1.05);
        }

        /* å­”æ˜ç¯æ ·å¼ç¾åŒ– */
        .lanternContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        /* éšè—æ„¿æœ›ç›¸å…³å…ƒç´  */
        .name, .gradient, #wish {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        /* ç§»åŠ¨ç«¯ä¸“ç”¨ä¼˜åŒ– */
        @media (max-width: 768px) {
            .controls {
                bottom: max(10px, env(safe-area-inset-bottom));
                padding: 0 15px;
            }

            .control-btn {
                padding: 10px 14px;
                font-size: 0.9rem;
                min-width: 90px;
                border-radius: 10px;
            }

            .art-text {
                font-size: clamp(3.5rem, 18vw, 9rem);
            }

            .new-year-link {
                width: min(500px, 85vw);
                height: min(150px, 35vh);
            }
        }

        @media (max-width: 480px) {
            /* å°å±å¹•è¿›ä¸€æ­¥ä¼˜åŒ– */
            body {
                cursor: default; /* å°å±å¹•ä½¿ç”¨é»˜è®¤å…‰æ ‡ */
            }

            .controls {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
                padding: 0 10px;
            }

            .control-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
                min-width: 85px;
                flex: 0 0 auto;
            }

            .art-text {
                font-size: clamp(3rem, 16vw, 6rem);
                padding: 0 15px;
            }

            .new-year-link {
                width: min(400px, 80vw);
                height: min(120px, 30vh);
            }
        }

        /* æ¨ªå±ä¼˜åŒ– */
        @media (orientation: landscape) and (max-height: 500px) {
            .controls {
                bottom: 5px;
                gap: 6px;
            }

            .control-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
                min-width: 80px;
            }

            .art-text {
                font-size: clamp(2.5rem, 15vw, 5rem);
            }
        }

        /* æ·±è‰²æ¨¡å¼æ”¯æŒ */
        @media (prefers-color-scheme: dark) {
            .control-btn {
                background: rgba(20, 20, 30, 0.9);
                border-color: rgba(76, 175, 80, 0.6);
            }
        }

        /* æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘åŠ¨ç”»å¤æ‚åº¦ */
        @media (prefers-reduced-motion: reduce) {
            .art-text,
            .control-btn,
            #lantern {
                transition: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- è‡ªå®šä¹‰å›¾ç‰‡èƒŒæ™¯ -->
    <div class="custom-background"></div>

    <!-- å­”æ˜ç¯ç”»å¸ƒ -->
    <svg id="lanterns" width="100%" height="100%" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
        <defs>
            <!-- å‘å…‰æ»¤é•œ -->
            <filter id="lantern-glow" x="-50%" y="-50%" width="200%" height="200%">
                <feGaussianBlur stdDeviation="4" result="blur"/>
                <feMerge>
                    <feMergeNode in="blur"/>
                    <feMergeNode in="SourceGraphic"/>
                </feMerge>
            </filter>

            <!-- ç¯ç¬¼ä¸»ä½“æ¸å˜ -->
            <linearGradient id="lantern-gradient" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" stop-color="#FFD700" stop-opacity="1"/>
                <stop offset="50%" stop-color="#FF8C00" stop-opacity="0.9"/>
                <stop offset="100%" stop-color="#FF4500" stop-opacity="0.8"/>
            </linearGradient>

            <!-- ç¯ç¬¼é¡¶éƒ¨æ¸å˜ -->
            <linearGradient id="lantern-top-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="#8B4513" stop-opacity="1"/>
                <stop offset="50%" stop-color="#A0522D" stop-opacity="0.9"/>
                <stop offset="100%" stop-color="#8B4513" stop-opacity="1"/>
            </linearGradient>

            <!-- ç¯ç¬¼è£…é¥°ç¬¦å· -->
            <g id="lantern-decoration">
                <!-- ç¦å­—ï¼ˆæ–°å¹´ç¥ç¦ç¬¦å·ï¼‰ -->
                <g id="fu-symbol">
                    <rect x="-5" y="-15" width="10" height="30" fill="#FF0000" rx="2"/>
                    <text x="0" y="5" text-anchor="middle" fill="#FFD700" font-family="'Ma Shan Zheng', cursive" font-size="20" font-weight="bold">ç¦</text>
                </g>

                <!-- å‰ç¥¥ç¬¦å· -->
                <g id="lucky-symbol">
                    <circle cx="0" cy="0" r="8" fill="none" stroke="#4CAF50" stroke-width="2"/>
                    <path d="M-5,0 L5,0 M0,-5 L0,5" stroke="#4CAF50" stroke-width="1.5"/>
                    <circle cx="0" cy="0" r="2" fill="#4CAF50"/>
                </g>
            </g>

            <!-- ç¾åŒ–çš„å­”æ˜ç¯å½¢çŠ¶ -->
            <g id="lantern">
                <!-- ç¯ç¬¼é¡¶éƒ¨ææ‰‹ -->
                <g class="lantern-top">
                    <rect x="-8" y="-45" width="16" height="10" rx="4" fill="url(#lantern-top-gradient)"/>
                    <rect x="-5" y="-35" width="10" height="5" rx="2" fill="#A0522D"/>
                </g>

                <!-- ç¯ç¬¼ä¸»ä½“ -->
                <g class="lantern-body" filter="url(#lantern-glow)">
                    <!-- ç¯ç¬¼å¤–éƒ¨å½¢çŠ¶ -->
                    <path d="M-20 -30
                             C-20 -35, -10 -40, 0 -40
                             C10 -40, 20 -35, 20 -30
                             L20 25
                             C20 30, 10 35, 0 35
                             C-10 35, -20 30, -20 25
                             Z"
                          fill="url(#lantern-gradient)"
                          stroke="#FF8C00"
                          stroke-width="2"/>

                    <!-- ç¯ç¬¼éª¨æ¶è£…é¥°çº¿ -->
                    <g class="lantern-frame">
                        <!-- å‚ç›´è£…é¥°çº¿ -->
                        <line x1="-15" y1="-25" x2="-15" y2="20" stroke="#FFA500" stroke-width="1" stroke-dasharray="3,2"/>
                        <line x1="0" y1="-30" x2="0" y2="25" stroke="#FFA500" stroke-width="1.2"/>
                        <line x1="15" y1="-25" x2="15" y2="20" stroke="#FFA500" stroke-width="1" stroke-dasharray="3,2"/>

                        <!-- æ°´å¹³è£…é¥°çº¿ -->
                        <ellipse cx="0" cy="-27" rx="18" ry="2" fill="none" stroke="#FFA500" stroke-width="1"/>
                        <ellipse cx="0" cy="-15" rx="16" ry="1.5" fill="none" stroke="#FFA500" stroke-width="0.8" stroke-dasharray="2,2"/>
                        <ellipse cx="0" cy="0" rx="17" ry="1.8" fill="none" stroke="#FFA500" stroke-width="1"/>
                        <ellipse cx="0" cy="15" rx="16" ry="1.5" fill="none" stroke="#FFA500" stroke-width="0.8" stroke-dasharray="2,2"/>
                        <ellipse cx="0" cy="27" rx="18" ry="2" fill="none" stroke="#FFA500" stroke-width="1"/>
                    </g>

                    <!-- ç¯ç¬¼è£…é¥°ç¬¦å· -->
                    <use xlink:href="#fu-symbol" x="0" y="-10"/>
                    <use xlink:href="#lucky-symbol" x="-12" y="5" transform="scale(0.8)"/>
                    <use xlink:href="#lucky-symbol" x="12" y="5" transform="scale(0.8)"/>

                    <!-- ç¯ç¬¼å†…å…‰æ™• -->
                    <ellipse cx="0" cy="0" rx="10" ry="15" fill="#FFF59D" opacity="0.3" filter="url(#lantern-glow)"/>
                </g>

                <!-- ç¯ç¬¼åº•éƒ¨è£…é¥° -->
                <g class="lantern-bottom">
                    <!-- ç¯ç¬¼åº•éƒ¨è¾¹ç¼˜ -->
                    <ellipse cx="0" cy="30" rx="22" ry="4" fill="#8B4513" stroke="#5D4037" stroke-width="1"/>

                    <!-- æµè‹è£…é¥° -->
                    <g class="lantern-tassel">
                        <!-- ä¸­å¿ƒæµè‹ -->
                        <path d="M0,30 C2,40 5,45 0,50 C-5,45 -2,40 0,30" fill="#FF6347"/>
                        <!-- æµè‹çº¿æ¡ -->
                        <g class="tassel-lines">
                            <line x1="-8" y1="32" x2="-8" y2="38" stroke="#FF6347" stroke-width="1"/>
                            <line x1="-4" y1="32" x2="-4" y2="40" stroke="#FF6347" stroke-width="1"/>
                            <line x1="0" y1="32" x2="0" y2="42" stroke="#FF6347" stroke-width="1.2"/>
                            <line x1="4" y1="32" x2="4" y2="40" stroke="#FF6347" stroke-width="1"/>
                            <line x1="8" y1="32" x2="8" y2="38" stroke="#FF6347" stroke-width="1"/>
                        </g>

                        <!-- æµè‹ç å­ -->
                        <circle cx="-6" cy="44" r="1.5" fill="#FFD700"/>
                        <circle cx="0" cy="46" r="2" fill="#FFD700"/>
                        <circle cx="6" cy="44" r="1.5" fill="#FFD700"/>
                    </g>
                </g>

                <!-- éšè—æ–‡å­—åŒºåŸŸ -->
                <foreignObject x="-20" y="-40" width="40" height="80" style="display: none;">
                    <div class="name" xmlns="http://www.w3.org/1999/xhtml">
                        <span class="gradient" style="display: none;"></span>
                    </div>
                </foreignObject>
            </g>
        </defs>
        <g class="lanternContainer"></g>
    </svg>

    <!-- çƒŸèŠ±ç”»å¸ƒ -->
    <canvas id="fireworks"></canvas>

    <!-- æ˜Ÿç©ºèƒŒæ™¯ -->
    <div id="sky"></div>

    <!-- æ•°å­—å’Œæ–‡å­—å®¹å™¨ -->
    <div class="text-container" id="text-container"></div>

    <!-- æ–°å¹´å¿«ä¹é“¾æ¥ -->
    <a href="./second.html" class="new-year-link" id="new-year-link"></a>

    <!-- æ§åˆ¶é¢æ¿ -->
    <div class="controls">
        <button id="toggle-music" class="control-btn">
            <span class="music-icon">ğŸµ</span> éŸ³ä¹
        </button>
        <button id="toggle-fireworks" class="control-btn">
            <span class="fireworks-icon">ğŸ†</span> çƒŸèŠ±
        </button>
        <button id="restart-countdown" class="control-btn">
            <span class="reset-icon">â±ï¸</span> é‡æ–°å¼€å§‹
        </button>
    </div>

    <!-- èƒŒæ™¯éŸ³ä¹ - æ”¹ä¸ºæ‚¨è‡ªå·±çš„MP3æ–‡ä»¶ -->
    <audio id="bg-music" loop preload="metadata">
    <source src="./audio/abs.mp3" type="audio/mpeg">
    æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ ã€‚
</audio>
    <script src="./js/utils.js"></script>
    <script src="./js/tinycolor.js"></script>
    <script src="./js/sky.js"></script>

    <!-- åŠ è½½å­”æ˜ç¯ç›¸å…³JS -->
    <script src="./js/wishes.js"></script>
    <script src="./js/lantern.js"></script>

    <!-- åŠ è½½çƒŸèŠ±JS -->
    <script src="./js/fireworks.js"></script>

    <script>
        // å¢åŠ å­”æ˜ç¯æ•°é‡
        (function() {
            // é»˜è®¤å­”æ˜ç¯æ•°é‡é…ç½®
            const LANTERN_COUNT = {
                desktop: 50, // ç”µè„‘ç«¯å¢åŠ æ›´å¤šå­”æ˜ç¯
                mobile: 30,  // ç§»åŠ¨ç«¯å¢åŠ å­”æ˜ç¯æ•°é‡
                tablet: 40   // å¹³æ¿è®¾å¤‡
            };

            // æ£€æµ‹è®¾å¤‡ç±»å‹
            function getLanternCount() {
                if (isMobile()) {
                    if (window.innerWidth <= 480) {
                        return LANTERN_COUNT.mobile;
                    } else {
                        return LANTERN_COUNT.tablet;
                    }
                }
                return LANTERN_COUNT.desktop;
            }

            // å¦‚æœæ˜¯ç§»åŠ¨ç«¯ï¼Œå¢åŠ å­”æ˜ç¯æ•°é‡
            if (isMobile()) {
                const count = getLanternCount();
                if (window.WISHES && window.WISHES.length > count) {
                    // ä½¿ç”¨æ›´å¤šçš„æ„¿æœ›æ¥åˆ›å»ºæ›´å¤šå­”æ˜ç¯
                    window.WISHES = window.WISHES.slice(0, count);
                } else if (window.WISHES && window.WISHES.length < count) {
                    // å¦‚æœæ„¿æœ›æ•°é‡ä¸è¶³ï¼Œå¤åˆ¶ä¸€äº›æ¥å¢åŠ æ•°é‡
                    const originalCount = window.WISHES.length;
                    const needed = count - originalCount;
                    for (let i = 0; i < needed; i++) {
                        const randomWish = window.WISHES[Math.floor(Math.random() * originalCount)];
                        window.WISHES.push(randomWish);
                    }
                }
            } else {
                // æ¡Œé¢ç«¯å¢åŠ æ›´å¤šå­”æ˜ç¯
                const count = getLanternCount();
                if (window.WISHES && window.WISHES.length > count) {
                    window.WISHES = window.WISHES.slice(0, count);
                } else if (window.WISHES && window.WISHES.length < count) {
                    const originalCount = window.WISHES.length;
                    const needed = count - originalCount;
                    for (let i = 0; i < needed; i++) {
                        const randomWish = window.WISHES[Math.floor(Math.random() * originalCount)];
                        window.WISHES.push(randomWish);
                    }
                }
            }
        })();

        // é¡µé¢çŠ¶æ€
        let currentPhase = 0;
        let isAnimationRunning = true;
        let restartRequested = false;

        // DOMå…ƒç´ 
        const textContainer = document.getElementById('text-container');
        const newYearLink = document.getElementById('new-year-link');
        const toggleMusicBtn = document.getElementById('toggle-music');
        const toggleFireworksBtn = document.getElementById('toggle-fireworks');
        const restartCountdownBtn = document.getElementById('restart-countdown');
        const bgMusic = document.getElementById('bg-music');

        // åˆ›å»ºè‰ºæœ¯æ–‡å­—
        function createArtText(text, styleClass) {
            const artText = document.createElement('div');
            artText.className = `art-text ${styleClass}`;
            artText.textContent = text;
            return artText;
        }

        // æ˜¾ç¤ºè‰ºæœ¯æ–‡å­—ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰
        function showArtText(text, styleClass, callback = null) {
            // æ¸…ç©ºå®¹å™¨
            while (textContainer.firstChild) {
                textContainer.removeChild(textContainer.firstChild);
            }

            const artText = createArtText(text, styleClass);
            textContainer.appendChild(artText);

            // ç§»åŠ¨ç«¯ä½¿ç”¨è¾ƒçŸ­çš„åŠ¨ç”»æ—¶é—´
            const transitionTime = isMobile() ? 500 : 700;

            // å»¶è¿Ÿåæ˜¾ç¤ºè‰ºæœ¯æ–‡å­—
            setTimeout(() => {
                artText.style.opacity = '1';

                if (callback) {
                    // æ˜¾ç¤ºåéšè—
                    setTimeout(() => {
                        artText.style.opacity = '0';

                        // éšè—åç§»é™¤å¹¶æ‰§è¡Œå›è°ƒ
                        setTimeout(() => {
                            if (artText.parentNode) {
                                artText.parentNode.removeChild(artText);
                            }
                            callback();
                        }, transitionTime);
                    }, transitionTime);
                }
            }, 100);
        }

        // å¼€å§‹å€’è®¡æ—¶ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰
        function startCountdown() {
            currentPhase = 0;
            let count = 10;

            function showCountdownNumber() {
                if (count < 0 || restartRequested) return;

                if (count > 0) {
                    const styleClass = `art-text-${count % 5}`;
                    showArtText(count.toString(), styleClass, () => {
                        count--;
                        setTimeout(showCountdownNumber, 50); // ç§»åŠ¨ç«¯å¢åŠ å»¶è¿Ÿå‡å°‘æ€§èƒ½å‹åŠ›
                    });
                } else {
                    show2026();
                }
            }

            showCountdownNumber();
        }

        // æ˜¾ç¤º2026è‰ºæœ¯å­—ä½“
        function show2026() {
            if (restartRequested) return;

            showArtText('2026', 'art-text-0', () => {
                showArtTextSequence();
            });
        }

        // æ˜¾ç¤ºè‰ºæœ¯æ–‡å­—åºåˆ—ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰
        function showArtTextSequence() {
            const texts = [
                {text: 'å¹³å®‰å–œä¹', style: 'art-text-1'},
                {text: 'ä¸‡äº‹é¡ºé‚', style: 'art-text-2'},
                {text: 'æ–°å¹´å¿«ä¹', style: 'art-text-3'}
            ];

            let index = 0;

            function showNextArtText() {
                if (index >= texts.length || restartRequested) return;

                const textObj = texts[index];
                showArtText(textObj.text, textObj.style, () => {
                    index++;
                    if (index < texts.length) {
                        setTimeout(showNextArtText, 100);
                    } else {
                        showFinalNewYearText();
                    }
                });
            }

            showNextArtText();
        }

        // æ˜¾ç¤ºæœ€ç»ˆæ–°å¹´å¿«ä¹å¹¶æ¿€æ´»é“¾æ¥ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰
        function showFinalNewYearText() {
            if (restartRequested) return;

            while (textContainer.firstChild) {
                const child = textContainer.firstChild;
                if (child.pulseInterval) {
                    clearInterval(child.pulseInterval);
                }
                textContainer.removeChild(child);
            }

            const finalText = createArtText('æ–°å¹´å¿«ä¹', 'art-text-4');
            textContainer.appendChild(finalText);

            // æ¿€æ´»æ–°å¹´å¿«ä¹é“¾æ¥
            newYearLink.classList.add('active');

            // è®¾ç½®é“¾æ¥ä½ç½®å’Œå¤§å°
            const textRect = finalText.getBoundingClientRect();
            const scaleFactor = isMobile() ? 0.8 : 1; // ç§»åŠ¨ç«¯ç¼©æ”¾å› å­
            newYearLink.style.width = `${(textRect.width + 100) * scaleFactor}px`;
            newYearLink.style.height = `${(textRect.height + 100) * scaleFactor}px`;
            newYearLink.style.left = `${textRect.left - 50 * scaleFactor + window.scrollX}px`;
            newYearLink.style.top = `${textRect.top - 50 * scaleFactor + window.scrollY}px`;
            newYearLink.style.transform = 'translate(0, 0)';

            // æ˜¾ç¤ºæœ€ç»ˆæ–‡å­—
            setTimeout(() => {
                finalText.style.opacity = '1';

                // ç§»åŠ¨ç«¯å‡å°‘è„‰åŠ¨é¢‘ç‡
                const pulseIntervalTime = isMobile() ? 1000 : 700;
                let pulseScale = 1;
                const pulseInterval = setInterval(() => {
                    pulseScale = pulseScale === 1 ? 1.03 : 1; // ç§»åŠ¨ç«¯å‡å°ç¼©æ”¾å¹…åº¦
                    finalText.style.transform = `translate(-50%, -50%) scale(${pulseScale})`;
                }, pulseIntervalTime);

                finalText.pulseInterval = pulseInterval;
            }, 100);
        }

        // é‡æ–°å¼€å§‹å€’è®¡æ—¶
        function restartCountdown() {
            restartRequested = true;

            while (textContainer.firstChild) {
                const child = textContainer.firstChild;
                if (child.pulseInterval) {
                    clearInterval(child.pulseInterval);
                }
                textContainer.removeChild(child);
            }

            newYearLink.classList.remove('active');
            newYearLink.style.width = isMobile() ? '85vw' : '800px';
            newYearLink.style.height = isMobile() ? '30vh' : '200px';
            newYearLink.style.left = '50%';
            newYearLink.style.top = '50%';
            newYearLink.style.transform = 'translate(-50%, -50%)';

            setTimeout(() => {
                restartRequested = false;
                startCountdown();
            }, 100);
        }

        // éŸ³ä¹æ§åˆ¶ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰
        function setupMusicControls() {
            let isMusicPlaying = false;

            toggleMusicBtn.addEventListener('click', function() {
                if (isMusicPlaying) {
                    bgMusic.pause();
                    toggleMusicBtn.innerHTML = '<span class="music-icon">ğŸ”‡</span> éŸ³ä¹';
                } else {
                    // ç§»åŠ¨ç«¯éœ€è¦ç”¨æˆ·äº¤äº’æ‰èƒ½æ’­æ”¾éŸ³é¢‘
                    const playPromise = bgMusic.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(e => {
                            console.log("éŸ³ä¹æ’­æ”¾è¢«é˜»æ­¢");
                            // æ˜¾ç¤ºæç¤º
                            toggleMusicBtn.innerHTML = '<span class="music-icon">âŒ</span> ç‚¹å‡»æ’­æ”¾';
                            setTimeout(() => {
                                toggleMusicBtn.innerHTML = '<span class="music-icon">ğŸµ</span> éŸ³ä¹';
                            }, 2000);
                        }).then(() => {
                            toggleMusicBtn.innerHTML = '<span class="music-icon">ğŸµ</span> éŸ³ä¹';
                        });
                    }
                }
                isMusicPlaying = !isMusicPlaying;
            });
        }

        // çƒŸèŠ±æ§åˆ¶ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰
        function setupFireworksControls() {
            let fireworksInstance = null;
            let isFireworksRunning = true;

            // åˆå§‹åŒ–çƒŸèŠ± - ç§»åŠ¨ç«¯å‡å°‘çƒŸèŠ±æ•°é‡
            setTimeout(() => {
                const dom = document.querySelector('#fireworks');
                // ç§»åŠ¨ç«¯å‡å°‘çƒŸèŠ±æ•°é‡
                const fireworkCount = isMobile() ? 8 : 24;
                const options = {
                    fps: isMobile() ? 30 : 45, // ç§»åŠ¨ç«¯é™ä½å¸§ç‡
                    useAnimationFrame: false,
                    fireworkCount: fireworkCount,
                    particleOptions: {
                        size: isMobile() ? 12 : 18,
                        speed: isMobile() ? 15 : 20,
                        particleCount: isMobile() ? 60 : 100,
                    },
                    fireworkInterval: isMobile() ? 300 : 200,
                };

                try {
                    fireworksInstance = new Fireworks(dom, options);
                    fireworksInstance.start();
                } catch (error) {
                    console.log("çƒŸèŠ±åˆå§‹åŒ–å¤±è´¥:", error);
                    toggleFireworksBtn.disabled = true;
                    toggleFireworksBtn.innerHTML = '<span class="fireworks-icon">âŒ</span> çƒŸèŠ±';
                    return;
                }

                // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶
                dom.addEventListener('touchstart', (event) => {
                    if (event.touches.length > 0 && fireworksInstance) {
                        event.preventDefault(); // é˜²æ­¢æ»šåŠ¨
                        const touch = event.touches[0];
                        fireworksInstance.createFirework(
                            touch.clientX,
                            touch.clientY
                        );
                    }
                }, { passive: false });

                // è‡ªåŠ¨æ·»åŠ æ›´å¤šçƒŸèŠ± - ç§»åŠ¨ç«¯å‡å°‘é¢‘ç‡
                setInterval(() => {
                    if (fireworksInstance && isFireworksRunning) {
                        const count = isMobile() ? 1 : 3;
                        for (let i = 0; i < count; i++) {
                            setTimeout(() => {
                                const x = random(100, window.innerWidth - 100);
                                const y = random(100, window.innerHeight - 100);
                                fireworksInstance.createFirework(x, y);
                            }, i * 300);
                        }
                    }
                }, isMobile() ? 8000 : 5000);

            }, 1000);

            toggleFireworksBtn.addEventListener('click', function() {
                if (fireworksInstance) {
                    if (isFireworksRunning) {
                        fireworksInstance.pause();
                        toggleFireworksBtn.innerHTML = '<span class="fireworks-icon">ğŸ‡</span> çƒŸèŠ±';
                    } else {
                        fireworksInstance.start();
                        toggleFireworksBtn.innerHTML = '<span class="fireworks-icon">ğŸ†</span> çƒŸèŠ±';
                    }
                    isFireworksRunning = !isFireworksRunning;
                }
            });
        }

        // ç§»åŠ¨è®¾å¤‡æ£€æµ‹
        function isMobile() {
            const toMatch = [
                /Android/i,
                /webOS/i,
                /iPhone/i,
                /iPad/i,
                /iPod/i,
                /BlackBerry/i,
                /Windows Phone/i,
            ];
            return toMatch.some((toMatchItem) => {
                return navigator.userAgent.match(toMatchItem);
            }) || window.innerWidth <= 768;
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–ï¼ˆç§»åŠ¨ç«¯ä¼˜åŒ–ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šé¢„åŠ è½½å…³é”®èµ„æº
            if ('connection' in navigator && navigator.connection.saveData) {
                console.log("çœæµé‡æ¨¡å¼å¼€å¯ï¼Œå‡å°‘ç‰¹æ•ˆ");
            }

            // åˆå§‹åŒ–éŸ³ä¹æ§åˆ¶
            setupMusicControls();

            // åˆå§‹åŒ–çƒŸèŠ±æ§åˆ¶
            setupFireworksControls();

            // é‡æ–°å¼€å§‹æŒ‰é’®
            restartCountdownBtn.addEventListener('click', restartCountdown);

            // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶æ”¯æŒ
            document.body.addEventListener('touchstart', function initMobile() {
                // ç§»åŠ¨ç«¯é¦–æ¬¡è§¦æ‘¸æ—¶æ’­æ”¾éŸ³ä¹
                if (bgMusic.paused) {
                    bgMusic.play().catch(e => {
                        console.log("è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢");
                    });
                }
                document.body.removeEventListener('touchstart', initMobile);
            }, { once: true });

            // ç§»åŠ¨ç«¯ç‚¹å‡»äº‹ä»¶
            document.body.addEventListener('click', function initClick() {
                if (bgMusic.paused) {
                    bgMusic.play().catch(e => {
                        console.log("è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢");
                    });
                }
                document.body.removeEventListener('click', initClick);
            }, { once: true });

            // å¼€å§‹å€’è®¡æ—¶
            setTimeout(startCountdown, 500);

            // ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–ï¼šé¡µé¢éšè—æ—¶æš‚åœåŠ¨ç”»
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // é¡µé¢éšè—æ—¶æš‚åœéŸ³ä¹å’ŒçƒŸèŠ±
                    if (bgMusic && !bgMusic.paused) bgMusic.pause();

                    // è¿™é‡Œå¯ä»¥æ·»åŠ çƒŸèŠ±æš‚åœé€»è¾‘
                }
            });

            // é¡µé¢å…³é—­æ—¶æ¸…ç†
            window.addEventListener('beforeunload', function() {
                const children = textContainer.children;
                for (let i = 0; i < children.length; i++) {
                    if (children[i].pulseInterval) {
                        clearInterval(children[i].pulseInterval);
                    }
                }
            });

            // ç§»åŠ¨ç«¯æ¨ªç«–å±åˆ‡æ¢å¤„ç†
            window.addEventListener('resize', function() {
                // é˜²æ­¢åœ¨ç§»åŠ¨ç«¯é¢‘ç¹è§¦å‘
                clearTimeout(this.resizeTimer);
                this.resizeTimer = setTimeout(function() {
                    // é‡æ–°è®¡ç®—é“¾æ¥ä½ç½®
                    if (newYearLink.classList.contains('active')) {
                        const finalText = document.querySelector('.art-text');
                        if (finalText) {
                            const textRect = finalText.getBoundingClientRect();
                            newYearLink.style.width = `${textRect.width + 100}px`;
                            newYearLink.style.height = `${textRect.height + 100}px`;
                            newYearLink.style.left = `${textRect.left - 50 + window.scrollX}px`;
                            newYearLink.style.top = `${textRect.top - 50 + window.scrollY}px`;
                        }
                    }
                }, 250);
            });
        });

        // ç§»åŠ¨ç«¯é˜²æŠ–å‡½æ•°
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>