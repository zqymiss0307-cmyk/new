<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¸©é¦¨å¼¹çª—ç¥ç¦</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Arial Rounded MT Bold', 'Arial', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            overflow: hidden;
            height: 100vh;
            position: relative;
            cursor: pointer;
            touch-action: manipulation;
        }

        /* å¢å¼ºèƒŒæ™¯æ•ˆæœ - ç§»åŠ¨ç«¯ç®€åŒ– */
        .background-effects {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
        }

        /* æ˜Ÿæ˜ŸèƒŒæ™¯ - ç§»åŠ¨ç«¯å‡å°‘æ˜Ÿæ˜Ÿæ•°é‡ */
        .star {
            position: absolute;
            background-color: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            opacity: 0;
            animation: twinkle 5s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1); }
        }

        /* æµåŠ¨çš„å…‰çº¿æ•ˆæœ - ç§»åŠ¨ç«¯å‡å°‘æ•°é‡ */
        .light-beam {
            position: absolute;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 215, 0, 0.4), transparent);
            opacity: 0.2;
            transform-origin: left;
        }

        /* ä¸»å®¹å™¨ - ç§»åŠ¨ç«¯ä¼˜åŒ– */
        .container {
            position: relative;
            z-index: 10;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right)
                     env(safe-area-inset-bottom) env(safe-area-inset-left);
        }

        /* å¼¹çª—æ ·å¼ - ç§»åŠ¨ç«¯å“åº”å¼ */
        .message-popup {
            position: absolute;
            width: min(280px, 85vw); /* ä½¿ç”¨minå‡½æ•°é™åˆ¶æœ€å¤§å®½åº¦ */
            height: min(140px, 30vh); /* ä½¿ç”¨minå‡½æ•°é™åˆ¶æœ€å¤§é«˜åº¦ */
            padding: min(20px, 4vw);
            border-radius: 15px;
            text-align: center;
            font-weight: bold;
            font-size: clamp(1.2rem, 4vw, 1.8rem); /* å“åº”å¼å­—ä½“ */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            transition: all 0.8s ease;
            cursor: pointer;
            user-select: none;
            word-wrap: break-word;
            line-height: 1.3;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            -webkit-user-select: none;
            touch-action: manipulation;
        }

        /* ä¸åŒé¢œè‰²çš„å¼¹çª— */
        .popup-color-1 {
            background: linear-gradient(135deg, #FF9A9E 0%, #FAD0C4 100%);
            color: #8B0000;
            border: 2px solid #FF6B6B;
        }

        .popup-color-2 {
            background: linear-gradient(135deg, #A1C4FD 0%, #C2E9FB 100%);
            color: #0A3D62;
            border: 2px solid #4A90E2;
        }

        .popup-color-3 {
            background: linear-gradient(135deg, #FFD89B 0%, #FFB347 100%);
            color: #5D4037;
            border: 2px solid #FF9800;
        }

        .popup-color-4 {
            background: linear-gradient(135deg, #D4FC79 0%, #96E6A1 100%);
            color: #1B5E20;
            border: 2px solid #4CAF50;
        }

        .popup-color-5 {
            background: linear-gradient(135deg, #FDA7DF 0%, #D980FA 100%);
            color: #4A148C;
            border: 2px solid #8E44AD;
        }

        .popup-color-6 {
            background: linear-gradient(135deg, #FFECD2 0%, #FCB69F 100%);
            color: #BF360C;
            border: 2px solid #E65100;
        }

        /* å¼¹çª—å›¾æ ‡ */
        .popup-icon {
            font-size: clamp(1.5rem, 6vw, 2rem);
            margin-bottom: 8px;
        }

        /* æœ€åå‰©ä¸‹çš„å¼¹çª— - ç§»åŠ¨ç«¯ä¼˜åŒ– */
        .final-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: clamp(20px, 8vw, 40px) clamp(25px, 10vw, 50px);
            border-radius: 20px;
            font-size: clamp(1.8rem, 7vw, 2.5rem);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: #8B4513;
            border: 3px solid #FF8C00;
            text-align: center;
            max-width: 90%;
            animation: pulse 2s infinite alternate;
            z-index: 10000;
            width: min(500px, 90vw);
        }

        @keyframes pulse {
            0% { transform: translate(-50%, -50%) scale(1); }
            100% { transform: translate(-50%, -50%) scale(1.03); } /* ç§»åŠ¨ç«¯å‡å°ç¼©æ”¾å¹…åº¦ */
        }

        .final-popup .popup-icon {
            font-size: clamp(2.5rem, 10vw, 3.5rem);
            margin-bottom: 15px;
        }

        /* å³ä¸‹è§’æ§åˆ¶é¢æ¿ - ç§»åŠ¨ç«¯ä¼˜åŒ– */
        .controls-panel {
            position: fixed;
            bottom: max(10px, env(safe-area-inset-bottom));
            right: max(10px, env(safe-area-inset-right));
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 1000;
            padding: 0 10px;
            width: 100%;
            align-items: flex-end;
        }

        /* ç»Ÿä¸€æŒ‰é’®æ ·å¼ - ç§»åŠ¨ç«¯ä¼˜åŒ– */
        .control-btn {
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid rgba(255, 215, 0, 0.7);
            border-radius: 10px;
            color: #FFD700;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            gap: 6px;
            min-width: 110px;
            justify-content: center;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .control-btn:hover {
            background: rgba(255, 215, 0, 0.2);
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* éŸ³ä¹æ§åˆ¶ç»„ - ç§»åŠ¨ç«¯ä¼˜åŒ– */
        .music-controls {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .music-btn {
            padding: 6px 10px;
            background: rgba(0, 0, 0, 0.85);
            border: 2px solid #4A90E2;
            border-radius: 8px;
            color: #4A90E2;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            gap: 4px;
            flex: 0 0 auto;
            justify-content: center;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .music-btn:hover {
            background: rgba(74, 144, 226, 0.2);
            transform: scale(1.05);
        }

        /* å…³é—­æŒ‰é’® */
        .close-btn {
            border-color: #FF6B6B;
            color: #FF6B6B;
        }

        .close-btn:hover {
            background: rgba(255, 107, 107, 0.2);
        }

        /* ç§»åŠ¨ç«¯å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .message-popup {
                width: min(240px, 80vw);
                height: min(120px, 25vh);
                padding: min(15px, 3vw);
                font-size: clamp(1.1rem, 3.5vw, 1.5rem);
                border-width: 1.5px;
            }

            .final-popup {
                padding: clamp(15px, 6vw, 30px) clamp(20px, 8vw, 40px);
                font-size: clamp(1.5rem, 6vw, 2rem);
                border-width: 2.5px;
            }

            .controls-panel {
                bottom: max(8px, env(safe-area-inset-bottom));
                right: max(8px, env(safe-area-inset-right));
            }

            .control-btn {
                padding: 8px 12px;
                font-size: 0.85rem;
                min-width: 100px;
            }

            .music-btn {
                padding: 5px 8px;
                font-size: 0.75rem;
            }
        }

        /* å°å±å¹•ä¼˜åŒ– */
        @media (max-width: 480px) {
            .controls-panel {
                width: auto;
                right: 50%;
                transform: translateX(50%);
                align-items: center;
            }

            .control-btn {
                min-width: auto;
                width: 140px;
            }

            .music-controls {
                width: 100%;
                justify-content: center;
            }

            .message-popup {
                width: min(200px, 75vw);
                height: min(100px, 22vh);
                padding: min(10px, 2.5vw);
                font-size: clamp(1rem, 3vw, 1.3rem);
            }

            /* å‡å°‘å¼¹çª—ç½‘æ ¼é—´è· */
            .grid-position {
                transition: all 0.8s ease-in-out !important;
            }
        }

        /* æ¨ªå±ä¼˜åŒ– */
        @media (orientation: landscape) and (max-height: 500px) {
            .controls-panel {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                bottom: 5px;
                gap: 4px;
            }

            .control-btn {
                padding: 6px 10px;
                font-size: 0.8rem;
                min-width: 90px;
            }

            .music-controls {
                width: auto;
            }

            .message-popup {
                width: min(180px, 40vw);
                height: min(90px, 30vh);
                font-size: clamp(0.9rem, 2.5vw, 1.2rem);
            }
        }

        /* å¼¹çª—å±‚çº§ç®¡ç† */
        .popup-layer-0 { z-index: 10; }
        .popup-layer-1 { z-index: 20; }
        .popup-layer-2 { z-index: 30; }
        .popup-layer-3 { z-index: 40; }
        .popup-layer-4 { z-index: 50; }
        .popup-layer-5 { z-index: 60; }
        .popup-layer-6 { z-index: 70; }
        .popup-layer-7 { z-index: 80; }
        .popup-layer-8 { z-index: 90; }
        .popup-layer-9 { z-index: 100; }
        .popup-layer-10 { z-index: 110; }

        /* é“ºæ»¡å±å¹•çš„ç½‘æ ¼ä½ç½® */
        .grid-position {
            transition: all 1s ease-in-out !important;
        }

        /* æ·±è‰²æ¨¡å¼æ”¯æŒ */
        @media (prefers-color-scheme: dark) {
            .control-btn,
            .music-btn {
                background: rgba(20, 20, 30, 0.9);
            }
        }

        /* æ€§èƒ½ä¼˜åŒ–ï¼šå‡å°‘åŠ¨ç”»å¤æ‚åº¦ */
        @media (prefers-reduced-motion: reduce) {
            .message-popup,
            .final-popup,
            .control-btn,
            .music-btn,
            .star,
            .light-beam {
                animation: none !important;
                transition: none !important;
            }

            .grid-position {
                transition: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯æ•ˆæœå±‚ -->
    <div class="background-effects" id="background-effects"></div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container" id="main-container">
        <!-- å¼¹çª—å°†åŠ¨æ€ç”Ÿæˆåˆ°è¿™é‡Œ -->

        <!-- æœ€åå‰©ä¸‹çš„å¼¹çª— -->
        <div class="message-popup final-popup" id="final-popup" style="display: none;">
            <div class="popup-icon">â¤ï¸</div>
            <div>2026</div>
            <div style="font-size: clamp(1rem, 4vw, 1.5rem); margin-top: 10px;">å¹³å®‰å–œä¹</div>
        </div>
    </div>

    <!-- å³ä¸‹è§’æ§åˆ¶é¢æ¿ -->
    <div class="controls-panel">
        <!-- ä¸»æ§åˆ¶æŒ‰é’® -->
        <button class="control-btn" id="restart-btn">
            <i class="fas fa-redo"></i> é‡æ–°å¼€å§‹
        </button>

        <button class="control-btn" id="pause-btn">
            <i class="fas fa-pause"></i> æš‚åœåŠ¨ç”»
        </button>

        <button class="control-btn close-btn" id="close-btn">
            <i class="fas fa-times"></i> å…³é—­é¡µé¢
        </button>

        <!-- éŸ³ä¹æ§åˆ¶ -->
        <div class="music-controls">
            <button class="music-btn" id="play-music-btn">
                <i class="fas fa-play"></i> æ’­æ”¾
            </button>
            <button class="music-btn" id="pause-music-btn">
                <i class="fas fa-pause"></i> æš‚åœ
            </button>
            <button class="music-btn" id="volume-up-btn">
                <i class="fas fa-volume-up"></i> éŸ³é‡+
            </button>
            <button class="music-btn" id="volume-down-btn">
                <i class="fas fa-volume-down"></i> éŸ³é‡-
            </button>
        </div>
    </div>

    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio id="background-music" loop preload="metadata">
        <source src="./audio/abs.mp3"type="audio/mpeg">
        æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ ã€‚
    </audio>

    <script>
        // ç§»åŠ¨ç«¯ä¼˜åŒ–ï¼šå‡å°‘æ¶ˆæ¯æ•°é‡
        const messages = [
            "å¤šå–æ°´å“¦",
            "è®°å¾—å‡†æ—¶åƒé¥­",
            "æ¢¦æƒ³æˆçœŸ",
            "æ—©ç‚¹ä¼‘æ¯",
            "é›¨è¿‡å¤©æ™´ï¼Œä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„",
            "é»„è€å¸ˆï¼Œè¾›è‹¦å’¯ï¼",
            "å¥½å‰å®³å‘€ï¼Œé»„è€å¸ˆï¼",
            "é»„è€å¸ˆï¼Œè¶…çº§æ— æ•Œå‰å®³ï¼ï¼",
            "æœˆäº®å¥½å¥½çœ‹ï¼Œä½ ä¹Ÿæ˜¯ï¼",
            "è¦å¤šå¥½åƒçš„ï¼Œå…»å¥½èº«ä½“å“¦ï¼",
            "ä½ ç¬‘èµ·æ¥çœŸçš„å¥½å¥½çœ‹ï¼",
            "é»„è€å¸ˆï¼Œå°‘ç†¬å¤œï¼Œæ—©ç‚¹ä¼‘æ¯ï¼",
            "é»„è€å¸ˆï¼Œå¤©å†·è®°å¾—åŠ è¡£ï¼",
            "æ„¿é»„è€å¸ˆçš„çƒ¦æ¼é€šé€šæ¶ˆå¤±ï¼",
            "é»„è€å¸ˆï¼Œè¦å¤©å¤©å¼€å¿ƒå“¦ï¼",
            "ä¿æŒå¾®ç¬‘",
            "é¡ºé¡ºåˆ©åˆ©",
            "ç´¯äº†å°±ä¼‘æ¯ï¼Œå¤šå·æ‡’æ‰å«ä¸Šç­ï¼",
            "äººç”Ÿä¸è¿‡ä¸‰ä¸‡å¤©ï¼Œèƒ½ç©ä¸€å¤©æ˜¯ä¸€å¤©",
            "é»„è€å¸ˆï¼Œæ¯å¤©éƒ½ä¼šå…ƒæ°”æ»¡æ»¡å“¦ï¼",
            "é»„è€å¸ˆï¼Œä¸‡äº‹é¡ºé‚ï¼",
            "é»„è€å¸ˆï¼Œæ–°å¹´å¿«ä¹ï¼",
            "æ¯å¤©ä¸è¦å¤ªç´¯äº†ï¼Œå¤šæ‘†çƒ‚1",
            "è¦å¥½å¥½çš„çˆ±è‡ªå·±ï¼Œå¤šå–æ‚¦è‡ªå·±å“¦",
            "å“‡ï¼Œé»„è€å¸ˆè¿™ä¹ˆå‰å®³ï¼ï¼ï¼",
            "å¸Œæœ›é¡ºåˆ©è·³å‡ºè¿™ç ´åœ°æ–¹å’Œå­¦æ ¡å“¦",

        ];

        // å¼¹çª—å›¾æ ‡åˆ—è¡¨
        const icons = ["â¤ï¸", "ğŸ’–", "âœ¨", "ğŸŒŸ", "ğŸŒ»", "ğŸŒ¸", "â˜€ï¸", "ğŸŒˆ", "â­", "ğŸ’"];

        // å¼¹çª—é¢œè‰²ç±»åˆ«
        const colorClasses = ["popup-color-1", "popup-color-2", "popup-color-3", "popup-color-4", "popup-color-5", "popup-color-6"];

        // å¼¹çª—å±‚çº§ç±»
        const layerClasses = [
            "popup-layer-0", "popup-layer-1", "popup-layer-2", "popup-layer-3", "popup-layer-4",
            "popup-layer-5", "popup-layer-6", "popup-layer-7", "popup-layer-8", "popup-layer-9"
        ];

        // çŠ¶æ€å˜é‡
        let popups = [];
        let phase = 1;
        let isPaused = false;
        let popupCount = 0;
        let maxPopups = 40; // ç§»åŠ¨ç«¯å‡å°‘å¼¹çª—æ•°é‡
        let creationSpeed = 400; // ç§»åŠ¨ç«¯é™ä½åˆ›å»ºé€Ÿåº¦
        let creationInterval;
        let currentLayerIndex = 0;
        let gridPositions = []; // å­˜å‚¨ç½‘æ ¼ä½ç½®
        let deleteSequence = []; // å­˜å‚¨åˆ é™¤é¡ºåº

        // å¼¹çª—å›ºå®šå°ºå¯¸ - ç§»åŠ¨ç«¯å“åº”å¼
        const popupWidth = 280;
        const popupHeight = 140;

        // DOMå…ƒç´ 
        const container = document.getElementById('main-container');
        const finalPopup = document.getElementById('final-popup');
        const backgroundEffects = document.getElementById('background-effects');
        const restartBtn = document.getElementById('restart-btn');
        const pauseBtn = document.getElementById('pause-btn');
        const closeBtn = document.getElementById('close-btn');

        // éŸ³ä¹ç›¸å…³å…ƒç´ 
        const bgMusic = document.getElementById('background-music');
        const playMusicBtn = document.getElementById('play-music-btn');
        const pauseMusicBtn = document.getElementById('pause-music-btn');
        const volumeUpBtn = document.getElementById('volume-up-btn');
        const volumeDownBtn = document.getElementById('volume-down-btn');

        // æ£€æµ‹ç§»åŠ¨ç«¯
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                   window.innerWidth <= 768;
        }

        // åˆå§‹åŒ–èƒŒæ™¯æ•ˆæœ - ç§»åŠ¨ç«¯ç®€åŒ–
        function initBackgroundEffects() {
            // åˆ›å»ºæ˜Ÿæ˜Ÿ - ç§»åŠ¨ç«¯å‡å°‘æ•°é‡
            const starCount = isMobile() ? 50 : 100;
            for (let i = 0; i < starCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';

                const left = Math.random() * 100;
                const top = Math.random() * 100;

                star.style.left = `${left}%`;
                star.style.top = `${top}%`;

                const size = 1 + Math.random() * 2; // ç§»åŠ¨ç«¯å‡å°æ˜Ÿæ˜Ÿå¤§å°
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;

                const delay = Math.random() * 5;
                star.style.animationDelay = `${delay}s`;

                const duration = 3 + Math.random() * 4;
                star.style.animationDuration = `${duration}s`;

                backgroundEffects.appendChild(star);
            }

            // åˆ›å»ºæµåŠ¨å…‰çº¿ - ç§»åŠ¨ç«¯å‡å°‘æ•°é‡
            if (!isMobile()) {
                for (let i = 0; i < 5; i++) {
                    const beam = document.createElement('div');
                    beam.className = 'light-beam';

                    const left = Math.random() * 100;
                    const top = Math.random() * 100;
                    const angle = Math.random() * 360;
                    const length = 50 + Math.random() * 100; // ç§»åŠ¨ç«¯å‡å°‘é•¿åº¦

                    beam.style.left = `${left}%`;
                    beam.style.top = `${top}%`;
                    beam.style.width = `${length}px`;
                    beam.style.transform = `rotate(${angle}deg)`;

                    beam.style.setProperty('--beam-angle', `${angle}deg`);
                    beam.style.animation = `moveBeam ${8 + Math.random() * 15}s linear infinite`;

                    backgroundEffects.appendChild(beam);
                }

                // æ·»åŠ å…‰æŸç§»åŠ¨åŠ¨ç”»
                const style = document.createElement('style');
                style.innerHTML = `
                    @keyframes moveBeam {
                        0% { transform: rotate(var(--beam-angle)) translateX(0); opacity: 0; }
                        10% { opacity: 0.4; }
                        90% { opacity: 0.4; }
                        100% { transform: rotate(var(--beam-angle)) translateX(200px); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        // è·å–ä¸‹ä¸€ä¸ªå±‚çº§ç±»
        function getNextLayerClass() {
            const layerClass = layerClasses[currentLayerIndex];
            currentLayerIndex = (currentLayerIndex + 1) % layerClasses.length;
            return layerClass;
        }

        // åˆ›å»ºéšæœºå¼¹çª— - ç§»åŠ¨ç«¯ä¼˜åŒ–
        function createRandomPopup() {
            if (popups.length >= maxPopups || phase !== 1) return;

            const popup = document.createElement('div');
            popup.className = 'message-popup';

            // éšæœºé¢œè‰²
            const colorClass = colorClasses[Math.floor(Math.random() * colorClasses.length)];
            popup.classList.add(colorClass);

            // åˆ†é…å±‚çº§
            const layerClass = getNextLayerClass();
            popup.classList.add(layerClass);

            // éšæœºå›¾æ ‡
            const icon = icons[Math.floor(Math.random() * icons.length)];

            // éšæœºæ¶ˆæ¯
            const message = messages[Math.floor(Math.random() * messages.length)];

            // è®¾ç½®å†…å®¹
            popup.innerHTML = `
                <div class="popup-icon">${icon}</div>
                <div>${message}</div>
            `;

            // å“åº”å¼å¼¹çª—å¤§å°
            const responsiveWidth = Math.min(popupWidth, window.innerWidth * 0.8);
            const responsiveHeight = Math.min(popupHeight, window.innerHeight * 0.3);

            popup.style.width = `${responsiveWidth}px`;
            popup.style.height = `${responsiveHeight}px`;

            // éšæœºä½ç½®
            const maxX = window.innerWidth - responsiveWidth;
            const maxY = window.innerHeight - responsiveHeight;
            const x = Math.max(10, Math.random() * maxX);
            const y = Math.max(10, Math.random() * maxY);

            popup.style.left = `${x}px`;
            popup.style.top = `${y}px`;

            // æ·»åŠ åˆ°å®¹å™¨
            container.appendChild(popup);
            popups.push(popup);
            popupCount++;

            // ç‚¹å‡»å¼¹çª—äº‹ä»¶ - ç§»åŠ¨ç«¯è§¦æ‘¸æ”¯æŒ
            popup.addEventListener('click', function(e) {
                e.stopPropagation();

                // ç‚¹å‡»æ•ˆæœ
                this.style.transform = 'scale(1.15)';
                this.style.boxShadow = '0 12px 25px rgba(0, 0, 0, 0.25)';

                // æ¢å¤åŸçŠ¶
                setTimeout(() => {
                    this.style.transform = 'scale(1)';
                    this.style.boxShadow = '0 8px 20px rgba(0, 0, 0, 0.2)';
                }, 300);
            });

            // å¼¹çª—å‡ºç°åŠ¨ç”»
            popup.style.opacity = '0';
            popup.style.transform = 'translateY(15px) scale(1)';

            setTimeout(() => {
                popup.style.transition = 'opacity 0.4s, transform 0.4s';
                popup.style.opacity = '1';
                popup.style.transform = 'translateY(0) scale(1)';
            }, 10);

            // å¦‚æœè¾¾åˆ°æœ€å¤§æ•°é‡ï¼Œè¿›å…¥é“ºæ»¡å±å¹•é˜¶æ®µ
            if (popups.length >= maxPopups && phase === 1) {
                enterPhase2();
            }
        }

        // è®¡ç®—é“ºæ»¡å±å¹•çš„ç½‘æ ¼ä½ç½® - ç§»åŠ¨ç«¯ä¼˜åŒ–
        function calculateGridPositions() {
            const positions = [];
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;

            // è®¡ç®—å¯ä»¥å®¹çº³çš„åˆ—æ•°å’Œè¡Œæ•°
            const responsiveWidth = Math.min(popupWidth, screenWidth * 0.8);
            const responsiveHeight = Math.min(popupHeight, screenHeight * 0.3);

            const cols = Math.floor(screenWidth / responsiveWidth);
            const rows = Math.floor(screenHeight / responsiveHeight);

            // è®¡ç®—é—´è·
            const horizontalGap = (screenWidth - cols * responsiveWidth) / (cols + 1);
            const verticalGap = (screenHeight - rows * responsiveHeight) / (rows + 1);

            // ç”Ÿæˆç½‘æ ¼ä½ç½®
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const x = horizontalGap + col * (responsiveWidth + horizontalGap);
                    const y = verticalGap + row * (responsiveHeight + verticalGap);
                    positions.push({ x, y, row, col });
                }
            }

            // å¦‚æœä½ç½®æ•°é‡è¶…è¿‡å¼¹çª—æ•°é‡ï¼Œå–å‰maxPopupsä¸ª
            if (positions.length > maxPopups) {
                return positions.slice(0, maxPopups);
            }

            // å¦‚æœä½ç½®æ•°é‡å°‘äºå¼¹çª—æ•°é‡ï¼Œæ·»åŠ ä¸€äº›é¢å¤–ä½ç½®
            while (positions.length < maxPopups) {
                const randomX = Math.random() * (screenWidth - responsiveWidth);
                const randomY = Math.random() * (screenHeight - responsiveHeight);
                positions.push({ x: randomX, y: randomY, row: -1, col: -1 });
            }

            return positions;
        }

        // ç¡®å®šåˆ é™¤é¡ºåºï¼ˆæŒ‰ç…§ç½‘æ ¼é¡ºåºï¼‰
        function determineDeleteOrder() {
            // åˆ›å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰å¼¹çª—ç´¢å¼•çš„æ•°ç»„
            const indices = Array.from({ length: popups.length }, (_, i) => i);

            // æŒ‰ç…§ç½‘æ ¼ä½ç½®æ’åºï¼šå…ˆæŒ‰è¡Œæ’åºï¼Œå†æŒ‰åˆ—æ’åº
            indices.sort((a, b) => {
                const posA = gridPositions[a];
                const posB = gridPositions[b];

                // å…ˆæ¯”è¾ƒè¡Œ
                if (posA.row !== posB.row) {
                    return posA.row - posB.row;
                }
                // å†æ¯”è¾ƒåˆ—
                return posA.col - posB.col;
            });

            return indices;
        }

        // åˆ é™¤å¼¹çª—ï¼ˆæŒ‰ç…§ç½‘æ ¼é¡ºåºï¼‰
        function deletePopupsInGridOrder() {
            if (deleteSequence.length === 0) return;

            const indexToDelete = deleteSequence.shift();

            if (indexToDelete < popups.length) {
                const popupToDelete = popups[indexToDelete];

                // åŠ¨ç”»æ•ˆæœ
                popupToDelete.style.transition = 'opacity 0.6s, transform 0.6s';
                popupToDelete.style.opacity = '0';
                popupToDelete.style.transform = 'scale(0.5) rotate(45deg)';

                // å»¶è¿Ÿç§»é™¤DOMå…ƒç´ 
                setTimeout(() => {
                    if (popupToDelete.parentNode) {
                        popupToDelete.parentNode.removeChild(popupToDelete);
                    }

                    // ä»æ•°ç»„ä¸­ç§»é™¤
                    popups.splice(indexToDelete, 1);

                    // è°ƒæ•´å‰©ä½™å¼¹çª—çš„ç´¢å¼•ï¼ˆå› ä¸ºæ•°ç»„æ”¹å˜äº†ï¼‰
                    // æ›´æ–°deleteSequenceä¸­å‰©ä½™çš„ç´¢å¼•
                    for (let i = 0; i < deleteSequence.length; i++) {
                        if (deleteSequence[i] > indexToDelete) {
                            deleteSequence[i]--;
                        }
                    }

                    // å¦‚æœè¿˜æœ‰å¼¹çª—ï¼Œç»§ç»­åˆ é™¤
                    if (deleteSequence.length > 0 && popups.length > 1) {
                        setTimeout(deletePopupsInGridOrder, 200);
                    } else if (popups.length === 1) {
                        // åªå‰©ä¸‹ä¸€ä¸ªå¼¹çª—ï¼Œç§»åŠ¨åˆ°ä¸­å¿ƒå¹¶æ˜¾ç¤ºä¸ºæœ€ç»ˆå¼¹çª—
                        const lastPopup = popups[0];

                        // æ·»åŠ æœ€ç»ˆå¼¹çª—æ ·å¼
                        lastPopup.classList.remove(...colorClasses);
                        lastPopup.classList.add('final-popup');
                        lastPopup.style.width = `${Math.min(500, window.innerWidth * 0.9)}px`;
                        lastPopup.style.height = 'auto';
                        lastPopup.style.padding = 'clamp(20px, 8vw, 40px) clamp(25px, 10vw, 50px)';
                        lastPopup.style.fontSize = 'clamp(1.8rem, 7vw, 2.5rem)';
                        lastPopup.style.background = 'linear-gradient(135deg, #FFD700 0%, #FFA500 100%)';
                        lastPopup.style.color = '#8B4513';
                        lastPopup.style.border = '3px solid #FF8C00';
                        lastPopup.style.borderRadius = '20px';
                        lastPopup.style.boxShadow = '0 15px 35px rgba(0, 0, 0, 0.3)';

                        // ç§»åŠ¨åˆ°ä¸­å¿ƒ
                        setTimeout(() => {
                            lastPopup.style.transition = 'left 1s, top 1s, transform 1s';
                            lastPopup.style.left = '50%';
                            lastPopup.style.top = '50%';
                            lastPopup.style.transform = 'translate(-50%, -50%) scale(1)';

                            // æ›´æ–°å†…å®¹
                            lastPopup.innerHTML = `
                                <div class="popup-icon">â¤ï¸</div>
                                <div>é»„è€å¸ˆå˜å˜å¥½çœ‹ï¼Œå˜å˜å‰å®³</div>
                                <div style="font-size: clamp(1rem, 4vw, 1.5rem); margin-top: 10px;">é»„è€å¸ˆæ–°å¹´å¿«ä¹ï¼Œå¹³å®‰å–œä¹</div>
                            `;

                            // æ·»åŠ è„‰åŠ¨åŠ¨ç”»
                            lastPopup.style.animation = 'pulse 2s infinite alternate';
                        }, 100);

                        // æ›´æ–°çŠ¶æ€
                        phase = 3;
                        pauseBtn.innerHTML = '<i class="fas fa-check"></i> å·²å®Œæˆ';
                        pauseBtn.disabled = true;
                    }
                }, 600);
            }
        }

        // è¿›å…¥ç¬¬äºŒé˜¶æ®µï¼šå¼¹çª—é“ºæ»¡å±å¹•
        function enterPhase2() {
            phase = 2;
            clearInterval(creationInterval);

            // è®¡ç®—ç½‘æ ¼ä½ç½®
            gridPositions = calculateGridPositions();

            // å°†å¼¹çª—ç§»åŠ¨åˆ°ç½‘æ ¼ä½ç½®
            popups.forEach((popup, index) => {
                if (index < gridPositions.length) {
                    const position = gridPositions[index];

                    // æ·»åŠ ç½‘æ ¼ä½ç½®ç±»
                    popup.classList.add('grid-position');

                    // ç§»åŠ¨åˆ°ç½‘æ ¼ä½ç½®
                    setTimeout(() => {
                        popup.style.left = `${position.x}px`;
                        popup.style.top = `${position.y}px`;
                        popup.style.transform = 'scale(1)';
                    }, index * 40); // ç§»åŠ¨ç«¯åŠ å¿«åŠ¨ç”»
                }
            });

            // æ‰€æœ‰å¼¹çª—ç§»åŠ¨å®Œæˆåï¼Œç¡®å®šåˆ é™¤é¡ºåºå¹¶å¼€å§‹åˆ é™¤
            setTimeout(() => {
                // ç¡®å®šåˆ é™¤é¡ºåº
                deleteSequence = determineDeleteOrder();

                // å¼€å§‹æŒ‰ç½‘æ ¼é¡ºåºåˆ é™¤å¼¹çª—
                if (deleteSequence.length > 0) {
                    // å»¶è¿Ÿä¸€ä¸‹å¼€å§‹åˆ é™¤
                    setTimeout(() => {
                        deletePopupsInGridOrder();
                    }, 500);
                }
            }, popups.length * 40 + 800); // ç§»åŠ¨ç«¯å‡å°‘ç­‰å¾…æ—¶é—´
        }

        // å¼€å§‹åŠ¨ç”»
        function startAnimation() {
            // é‡ç½®çŠ¶æ€
            phase = 1;
            popups = [];
            popupCount = 0;
            isPaused = false;
            currentLayerIndex = 0;
            gridPositions = [];
            deleteSequence = [];

            // æ¸…ç©ºå®¹å™¨
            const children = container.children;
            for (let i = children.length - 1; i >= 0; i--) {
                if (children[i].id !== 'final-popup') {
                    container.removeChild(children[i]);
                }
            }

            // éšè—æœ€ç»ˆå¼¹çª—
            finalPopup.style.display = 'none';

            // å¯ç”¨æš‚åœæŒ‰é’®
            pauseBtn.disabled = false;
            pauseBtn.innerHTML = '<i class="fas fa-pause"></i> æš‚åœåŠ¨ç”»';

            // è°ƒæ•´ç§»åŠ¨ç«¯å‚æ•°
            if (isMobile()) {
                maxPopups = 30;
                creationSpeed = 500;
            }

            // å¼€å§‹åˆ›å»ºå¼¹çª—
            creationInterval = setInterval(createRandomPopup, creationSpeed);
        }

        // æš‚åœ/ç»§ç»­åŠ¨ç”»
        function togglePause() {
            if (phase === 3) return;

            isPaused = !isPaused;

            if (isPaused) {
                clearInterval(creationInterval);
                pauseBtn.innerHTML = '<i class="fas fa-play"></i> ç»§ç»­åŠ¨ç”»';
            } else {
                creationInterval = setInterval(createRandomPopup, creationSpeed);
                pauseBtn.innerHTML = '<i class="fas fa-pause"></i> æš‚åœåŠ¨ç”»';
            }
        }

        // ç‚¹å‡»å±å¹•åŠ é€Ÿå¼¹çª—æ¶Œç° - ç§»åŠ¨ç«¯è§¦æ‘¸æ”¯æŒ
        container.addEventListener('click', function(e) {
            if (e.target === this && phase === 1 && !isPaused) {
                // åˆ›å»ºå¼¹çª—
                const createCount = isMobile() ? 2 : 3;
                for (let i = 0; i < createCount; i++) {
                    if (popups.length < maxPopups) {
                        createRandomPopup();
                    }
                }

                // å¦‚æœè¾¾åˆ°æœ€å¤§æ•°é‡ï¼Œè¿›å…¥ç¬¬äºŒé˜¶æ®µ
                if (popups.length >= maxPopups && phase === 1) {
                    enterPhase2();
                }
            }
        });

        // éŸ³ä¹æ§åˆ¶åŠŸèƒ½ - ç§»åŠ¨ç«¯ä¼˜åŒ–
        function setupMusicControls() {
            // è®¾ç½®åˆå§‹éŸ³é‡
            bgMusic.volume = 0.5;

            // æ’­æ”¾éŸ³ä¹
            playMusicBtn.addEventListener('click', function() {
                const playPromise = bgMusic.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('èƒŒæ™¯éŸ³ä¹å¼€å§‹æ’­æ”¾');
                    }).catch(error => {
                        console.log('æ’­æ”¾å¤±è´¥:', error);
                        playMusicBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> ç‚¹å‡»æ’­æ”¾';
                        playMusicBtn.style.borderColor = '#FF6B6B';
                        playMusicBtn.style.color = '#FF6B6B';

                        setTimeout(() => {
                            playMusicBtn.innerHTML = '<i class="fas fa-play"></i> æ’­æ”¾';
                            playMusicBtn.style.borderColor = '';
                            playMusicBtn.style.color = '';
                        }, 2000);
                    });
                }
            });

            // æš‚åœéŸ³ä¹
            pauseMusicBtn.addEventListener('click', function() {
                bgMusic.pause();
            });

            // å¢åŠ éŸ³é‡
            volumeUpBtn.addEventListener('click', function() {
                if (bgMusic.volume < 1) {
                    bgMusic.volume = Math.min(1, bgMusic.volume + 0.1);
                }
            });

            // å‡å°éŸ³é‡
            volumeDownBtn.addEventListener('click', function() {
                if (bgMusic.volume > 0) {
                    bgMusic.volume = Math.max(0, bgMusic.volume - 0.1);
                }
            });

            // å°è¯•è‡ªåŠ¨æ’­æ”¾éŸ³ä¹
            setTimeout(() => {
                if (!isMobile()) {
                    bgMusic.play().then(() => {
                        console.log('èƒŒæ™¯éŸ³ä¹è‡ªåŠ¨æ’­æ”¾');
                    }).catch(error => {
                        console.log('è‡ªåŠ¨æ’­æ”¾è¢«é˜»æ­¢ï¼Œè¯·ç‚¹å‡»æ’­æ”¾æŒ‰é’®');
                    });
                }
            }, 1000);
        }

        // å…³é—­é¡µé¢
        function setupCloseButton() {
            closeBtn.addEventListener('click', function() {
                if (confirm("ç¡®å®šè¦å…³é—­è¿™ä¸ªé¡µé¢å—ï¼Ÿ")) {
                    window.close();
                }
            });
        }

        // æŒ‰é’®äº‹ä»¶ç›‘å¬
        restartBtn.addEventListener('click', startAnimation);
        pauseBtn.addEventListener('click', togglePause);

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', function() {
            initBackgroundEffects();
            setupMusicControls();
            setupCloseButton();

            // å»¶è¿Ÿå¼€å§‹åŠ¨ç”»
            setTimeout(startAnimation, 800);

            // å“åº”çª—å£å¤§å°å˜åŒ– - ç§»åŠ¨ç«¯é˜²æŠ–
            let resizeTimer;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimer);
                resizeTimer = setTimeout(() => {
                    // åœ¨é“ºæ»¡å±å¹•é˜¶æ®µï¼Œé‡æ–°è®¡ç®—ç½‘æ ¼ä½ç½®
                    if (phase === 2 || phase === 3) {
                        const newGridPositions = calculateGridPositions();

                        popups.forEach((popup, index) => {
                            if (index < newGridPositions.length) {
                                const position = newGridPositions[index];
                                popup.style.left = `${position.x}px`;
                                popup.style.top = `${position.y}px`;
                            }
                        });

                        // æ›´æ–°ç½‘æ ¼ä½ç½®æ•°ç»„
                        gridPositions = newGridPositions;
                    }
                }, 250);
            });

            // ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–
            document.addEventListener('visibilitychange', function() {
                if (document.hidden) {
                    // é¡µé¢éšè—æ—¶æš‚åœéŸ³ä¹
                    if (bgMusic && !bgMusic.paused) bgMusic.pause();

                    // æš‚åœåŠ¨ç”»
                    if (!isPaused && phase !== 3) {
                        togglePause();
                    }
                }
            });

            // ç§»åŠ¨ç«¯è§¦æ‘¸äº‹ä»¶æ”¯æŒ
            document.addEventListener('touchstart', function(e) {
                // é˜²æ­¢åŒå‡»ç¼©æ”¾
                if (e.touches.length > 1) {
                    e.preventDefault();
                }
            }, { passive: false });

            // ç¦ç”¨åŒå‡»ç¼©æ”¾
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function(e) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, false);
        });
    </script>
</body>
</html>